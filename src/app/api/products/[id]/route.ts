// /app/api/products/[id]/route.ts

import { NextRequest, NextResponse } from "next/server";
import connectDB from "@backend/config/db";
import { ObjectId } from "mongodb";

export async function GET(
  req: NextRequest,
  context: { params?: { id?: string } }
) {
  try {
    const { params } = context;

    // üõë Ki·ªÉm tra params t·ªìn t·∫°i tr∆∞·ªõc khi s·ª≠ d·ª•ng
    if (!params || !params.id) {
      return NextResponse.json({ error: "Missing product ID" }, { status: 400 });
    }

    const id = params.id;

    // üõë Ki·ªÉm tra ID c√≥ h·ª£p l·ªá kh√¥ng
    if (!ObjectId.isValid(id)) {
      return NextResponse.json({ error: "Invalid product ID" }, { status: 400 });
    }

    // ‚úÖ K·∫øt n·ªëi database
    const db = await connectDB();
    if (!db) {
      return NextResponse.json({ error: "Database connection failed" }, { status: 500 });
    }

    // ‚úÖ T√¨m s·∫£n ph·∫©m trong MongoDB
    const product = await db.collection("test").findOne({ _id: new ObjectId(id) });

    // üõë Ki·ªÉm tra n·∫øu s·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i
    if (!product) {
      return NextResponse.json({ error: "Product not found" }, { status: 404 });
    }

    return NextResponse.json(product);
  } catch (error) {
    console.error("‚ùå L·ªói khi l·∫•y chi ti·∫øt s·∫£n ph·∫©m:", error);
    return NextResponse.json({ error: "Failed to fetch product details" }, { status: 500 });
  }
}
// Th√™m PATCH v√† DELETE n·∫øu c·∫ßn
export const PATCH = async (
  req: NextRequest,
  { params }: { params: { id: string } }
) => {
  try {
    const db = await connectDB();
    if (!db) return NextResponse.json({ error: "Database connection failed" }, { status: 500 });

    const id = params.id;
    if (!ObjectId.isValid(id)) {
      return NextResponse.json({ error: "Invalid product ID" }, { status: 400 });
    }

    const updates = await req.json();
    const result = await db.collection("test").updateOne(
      { _id: new ObjectId(id) },
      { $set: updates }
    );

    if (result.matchedCount === 0) {
      return NextResponse.json({ error: "Product not found" }, { status: 404 });
    }

    return NextResponse.json({ message: "Product updated successfully" });
  } catch (error) {
    console.error("‚ùå PATCH Error:", error);
    return NextResponse.json({ error: "Failed to update product" }, { status: 500 });
  }
};

export const DELETE = async (
  req: NextRequest,
  { params }: { params: { id: string } }
) => {
  try {
    const db = await connectDB();
    if (!db) return NextResponse.json({ error: "Database connection failed" }, { status: 500 });

    const id = params.id;
    if (!ObjectId.isValid(id)) {
      return NextResponse.json({ error: "Invalid product ID" }, { status: 400 });
    }

    const result = await db.collection("test").deleteOne({ _id: new ObjectId(id) });

    if (result.deletedCount === 0) {
      return NextResponse.json({ error: "Product not found" }, { status: 404 });
    }

    return NextResponse.json({ message: "Product deleted successfully" });
  } catch (error) {
    console.error("‚ùå DELETE Error:", error);
    return NextResponse.json({ error: "Failed to delete product" }, { status: 500 });
  }
};